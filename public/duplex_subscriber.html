<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:svg="http://www.w3.org/2000/svg"
	xmlns:xlink="http://www.w3.org/1999/xlink"
	xml:lang="en" lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link type="text/css" rel="stylesheet" href="stylesheet/application.css" />
  

  <script src="javascript/jquery-1.4.2.js"></script>
  <script type="text/ecmascript" src="javascript/duplex_subscriber.js"></script>
  <script type="text/ecmascript">
    var subscriber = null;
    var wsAddress = "ws://192.168.2.3:80/duplex_subscriber";
    var sid = "::aa";
    var messageElementId = "messages";

    window.onload = function() {
      $('.seat').each(function() {
        this.rid = "::"+ this.id;
        this.seat = new Seat(sid, this.rid, this.id);

        
        $(this).append('<img class="reservation click" src="images/reserve.png">');
        $(this).append('<img class="reserved" src="images/reserved.png">');
        $(this).append('<img class="confirmed" src="images/my_reservation.png">');
        $(this).append(
           "<ul>"
          +  "<li class='reserved-at'>Reserved at 6.7.2010 20:30</li>"
          +  "<li class='reserved-by'>Peke Vaara</li>"
          + "</ul>");
        $(this).append('<button class="cancel click">Cancel reservation</button>');
        
        this.testi = function() {
          alert("this" + this.rid);
        }
        
        this.reserverName = function() {
          return $("#"+this.id +" .reserved-by").html();
        }
        
        // this.onclick = function() {
        //   alert("div")
        //         // this.seat.reserve();
        // }
      
      });
      
      $('.seat img.reservation').live('click', function() {
        $(this).parent()[0].seat.reserve();
      });
      
      $('.seat button.cancel').live('click', function() {
        $(this).parent()[0].seat.cancel();
      });
      
      messageSubscriber = new Subscriber(wsAddress, messageElementId, sid, "::bb");

    }
    function debug(str) {
      $("#debug").append(str + "<br />");
    };
    
    function markMyReservations(name) {
      $('.seat').each(function() {
        if (this.reserverName() == name) {
          this.seat.confirm();
        }
      });
    };
    
    function myName() {
      return $('#username').val();
    }
    
    function announceMyPrecense() {
      if (myName() == "") {
        alert("Fill in your name first.");
        return;
      }
      
      messageSubscriber.sendMessage(myName() + " has come to get some seats!");
    }
    
    var Seat = function(sid, rid, domId) {
      this.domId = domId;
      this.sid = sid;
      this.rid = rid;
      this.subscriber = new Subscriber(wsAddress, messageElementId, this.sid, this.rid, this);

      this.reserve = function() {
        if (document.getElementById("username").value == "") {
          alert("Fill in your name first.");
          return;
        }
        this.subscriber.sendRequest("SEAT_RESERVATION");
        $("#"+this.domId).addClass("unconfirmed");
      };
      
      this.confirm = function() {
        $("#"+this.domId).removeClass("unconfirmed");
        $("#"+this.domId).addClass("confirmed");
        $("#"+this.domId+" img.confirmed").show();
        $("#"+this.domId+" img.reserved").hide();
        
      };
      
      /* NB. Since all application logic is in JavaScript, it is easily bypassed.
       *     Of course you can manually call cancel() function and bypass "security",
       *     but that is not the point here.
       *
       *     Now we depend on the caller to check that I am allowed to call this method.
       */
      this.cancel = function() {
        this.subscriber.sendRequest("SEAT_CANCELLATION");
        $("#"+this.domId).removeClass("unavailable");
        $("#"+this.domId).addClass("available");
        
      }
      
      this.make_unavailable = function() {
        $("#"+this.domId).removeClass("available");
        $("#"+this.domId).addClass("unavailable");
        $("#"+this.domId+" button.cancel").show();
        $("#"+this.domId+" img.reservation").hide();
        $("#"+this.domId+" img.reserved").show();
      };

      this.make_available = function() {
        $("#"+this.domId).removeClass("unavailable");
        $("#"+this.domId).addClass("available");
        $("#"+this.domId+" button.cancel").hide();
        $("#"+this.domId+" img.reservation").show();
        $("#"+this.domId+" img.reserved").hide();
        
      };
      
      
    } 
  </script>

  
</head>

<body>

<h1>Interaction experiment</h1>
<!-- <p>Nothing is escaped in received content!</p> -->
<p>Reserving a Theater Seat. <br/>Black seat is available, red seat is reserved.</p>


<label for="username">My name is:</label>
<input name="username" id="username" onblur="markMyReservations(this.value);">


<button onclick="announceMyPrecense();">Annonounce me!</button>

<fieldset class="seats">
  <legend>Seats in Theatre X</legend>
    <div class="seat" id="a1"></div>
    <div class="seat" id="a2"></div>
    <div class="seat" id="a3"></div>
    <div class="seat" id="a4"></div>
    <div class="seat" id="a5"></div>
    <div class="seat" id="a6"></div>
</fieldset>

<button onclick="document.getElementById(messageElementId).innerHTML=''">Clear messages</button>
<button onclick="document.getElementById('debug').innerHTML=''">Clear debug</button>

<fieldset>
  <legend>Debug</legend>
  <div id="debug"></div>
</fieldset>

<fieldset>
  <legend>Received messages</legend>
  <div id="messages"></div>
</fieldset>

</body>

</html>